#!/usr/bin/env zsh

# Get the Home Trackpad MAC address from connected devices
get_trackpad_address() {
  system_profiler SPBluetoothDataType 2>/dev/null | \
    grep -i -A 10 "Home Trackpad" | \
    grep "Address" | \
    head -1 | \
    awk '{print $NF}'
}

case "${1:-switch}" in
  unpair)
    TRACKPAD_ADDR=$(get_trackpad_address)

    if [[ -z "$TRACKPAD_ADDR" ]]; then
      echo "âš ï¸  No trackpad currently connected."
      exit 1
    fi

    echo "ðŸ”µ Found trackpad: $TRACKPAD_ADDR"
    echo "ðŸ”Œ Unpairing trackpad..."
    blueutil --unpair "$TRACKPAD_ADDR"

    echo "âœ… Trackpad unpaired. You can now pair it with another computer."
    ;;

  pair)
    echo "ðŸ” Scanning for trackpad in pairing mode..."
    echo "ðŸ’¡ Make sure your trackpad is in pairing mode (hold power button until LED blinks)"
    echo ""
    
    blueutil --inquiry 5 2>/dev/null | while read -r line; do
      if echo "$line" | grep -iq "Home Trackpad"; then
        ADDR=$(echo "$line" | awk '{print $2}' | tr -d ',')
        echo "ðŸ”µ Found trackpad: $ADDR"
        echo "ðŸ”— Attempting to pair..."
        blueutil --pair "$ADDR"
        echo "âœ… Pairing initiated!"
        break
      fi
    done
    ;;

  switch)
    TRACKPAD_ADDR=$(get_trackpad_address)

    if [[ -n "$TRACKPAD_ADDR" ]]; then
      echo "ðŸ”µ Found trackpad: $TRACKPAD_ADDR"
      echo "ðŸ”Œ Unpairing trackpad..."
      blueutil --unpair "$TRACKPAD_ADDR"
      echo "âœ… Trackpad unpaired."
      echo ""
    else
      echo "âš ï¸  No trackpad currently connected. Skipping unpair step."
      echo ""
    fi

    echo "ðŸ” Now scanning for trackpad in pairing mode..."
    echo "ðŸ’¡ Put your trackpad in pairing mode (hold power button until LED blinks)"
    echo ""
    sleep 2
    
    blueutil --inquiry 5 2>/dev/null | while read -r line; do
      if echo "$line" | grep -iq "Home Trackpad"; then
        ADDR=$(echo "$line" | awk '{print $2}' | tr -d ',')
        echo "ðŸ”µ Found trackpad: $ADDR"
        echo "ðŸ”— Attempting to pair..."
        blueutil --pair "$ADDR"
        echo "âœ… Pairing initiated!"
        break
      fi
    done
    ;;

  *)
    echo "Usage: trackpad-connect [switch|unpair|pair]"
    echo ""
    echo "  switch  - Unpair then pair again (default)"
    echo "  unpair  - Unpair current trackpad"
    echo "  pair    - Scan and pair trackpad in pairing mode"
    exit 1
    ;;
esac
