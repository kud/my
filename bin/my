#! /usr/bin/env zsh

# main command
source $MY/core/utils/helper.zsh
source $MY/core/utils/ui-kit.zsh

# Check for debug flag and set environment variable
export MY_DEBUG=false
if [[ "$1" == "--debug" ]]; then
  export MY_DEBUG=true
  shift # Remove --debug from arguments
  ui_warning_simple "Debug mode enabled - verbose logging active"
  ui_spacer
fi

if [[ $# -eq 0 ]]; then
  $0 --help
else

  case "$1" in
  # Direct commands (only core/commands)
  install)
    $MY/core/commands/install.zsh
    ;;
  update)
    $MY/core/commands/update.zsh
    ;;
  info)
    $MY/core/commands/info.zsh
    ;;
  uninstall)
    $MY/core/commands/uninstall.zsh
    ;;
  brew-clean)
    $MY/core/commands/brew-clean.zsh
    ;;
  npm-clean)
    $MY/core/commands/npm-clean.zsh
    ;;
  doctor)
    $MY/core/commands/doctor.zsh
    ;;
  profile-update)
    $MY/core/commands/profile-update.zsh
    ;;
  migrate)
    $MY/core/system/migrations.zsh "${@:2}"
    ;;
  services)
    $MY/core/system/services.zsh "${@:2}"
    ;;

  # Everything else under run
  run)
    if [[ -z "$2" ]]; then
      echo "Error: 'run' requires a module name. Available modules:"
      echo "  Apps: firefox (use -sc for shortcuts), keepassxc, pcloud, sublime-merge, bruno, claude-desktop"
      echo "  CLI: abbr, basic-memory, claude-code, codex, github-copilot, mistral-vibe, opencode, ssh"
      echo "  Packages: antidote, brew, gh, gem, mas, npm, uv"
      echo "  System: default-folders, doc, dotfiles, edit, open, os, services, shims, submodules, symlinks"
      echo "  Utils: ui-kit-demo"
      exit 1
    fi

    case "$2" in
    # System modules
    os)
      $MY/core/os/main.zsh
      ;;
    services)
      $MY/core/system/services.zsh install
      ;;
    postinstall)
      $MY/core/system/post-install.zsh "${@:3}"
      ;;
    doc)
      open https://github.com/kud/my/tree/master/doc
      ;;
    edit)
      code $MY
      ;;
    open)
      open $MY
      ;;

    # Apps (core/apps)
    firefox)
      shift 2
      $MY/core/apps/firefox.zsh "$@"
      ;;
    keepassxc)
      $MY/core/apps/keepassxc.zsh
      ;;
    pcloud)
      $MY/core/apps/pcloud.zsh
      ;;
    sublime-merge)
      $MY/core/apps/sublime-merge.zsh
      ;;
    bruno)
      $MY/core/apps/bruno.zsh
      ;;
    claude-desktop)
      shift 2
      $MY/core/apps/claude-desktop.zsh "$@"
      ;;

    # CLI tools (core/cli)
    abbr)
      $MY/core/cli/abbr.zsh
      ;;
    claude-code)
      shift 2
      $MY/core/cli/claude-code.zsh "$@"
      ;;
    codex)
      shift 2
      $MY/core/cli/codex.zsh "$@"
      ;;
    opencode)
      shift 2
      $MY/core/cli/opencode.zsh "$@"
      ;;
    basic-memory)
      shift 2
      $MY/core/cli/basic-memory.zsh "$@"
      ;;
    github-copilot)
      shift 2
      $MY/core/cli/github-copilot.zsh "$@"
      ;;
    mistral-vibe)
      shift 2
      $MY/core/cli/mistral-vibe.zsh "$@"
      ;;
    ssh)
      $MY/core/system/ssh.zsh
      ;;

    # Packages (core/packages)
    antidote)
      $MY/core/packages/antidote.zsh
      ;;
    brew)
      $MY/core/packages/brew.zsh
      ;;
    gh)
      $MY/core/packages/gh.zsh
      ;;
    gem)
      $MY/core/packages/gem.zsh
      ;;
    mas)
      $MY/core/packages/mas.zsh
      ;;
    npm)
      $MY/core/packages/npm.zsh
      ;;
    uv)
      # Python development packages installer (uv only)
      $MY/core/packages/uv.zsh
      ;;
    mise)
      $MY/core/packages/mise.zsh # relocated from core/mise.zsh
      ;;

    # System (core/system) - fallback and specific ones
    dotfiles)
      $MY/core/system/dotfiles.zsh
      ;;
    symlinks)
      $MY/core/system/symlinks.zsh
      ;;
    shims)
      $MY/core/system/shims.zsh
      ;;
    submodules)
      $MY/core/system/submodules.zsh
      ;;
    default-folders)
      $MY/core/system/default-folders.zsh
      ;;
    
    # Utils (core/utils)
    ui-kit-demo)
      $MY/core/utils/ui-kit-demo.zsh
      ;;
    
    *)
      if [[ -f "$MY/core/system/$2.zsh" ]]; then
        $MY/core/system/$2.zsh
      else
        echo "Error: Module '$2' not found. Use 'my --help' to see available modules."
        exit 1
      fi
      ;;
    esac
    ;;

  --help|-h|help)
    ui_spacer
    ui_primary "My Environment Manager"
    ui_spacer

    ui_info_simple "A comprehensive development environment management tool for macOS"
    ui_spacer

    ui_subtitle "Usage:"
    echo "  my <command>          Run command directly"
    echo "  my run <module>       Run specific module"
    echo "  my --debug <command>  Run with verbose debugging"
    echo "  my --help             Show this help"

    ui_spacer
    ui_subtitle "Direct Commands:"
    echo "  install               Set up complete development environment"
    echo "  update                Refresh all components and packages"
    echo "  profile-update        Update only current profile packages"
    echo "  info                  Show environment info (version/host/profile)"
    echo "  uninstall             Remove the project"
    echo "  doctor                Check system health and configuration"
    echo "  migrate               Run pending one-time migrations"
    echo "  services              Manage system services (LaunchDaemons)"
    echo "  brew-clean            Remove unused Homebrew packages"
    echo "  npm-clean             Clean up Node.js global packages"

    ui_spacer
    ui_subtitle "Module Categories (use with 'my run <module>'):"

    echo
    echo "  Package Managers:"
    echo "    antidote, brew, gh, gem, mas, npm, uv, mise"
    echo
    echo "  Applications:"
    echo "    firefox, keepassxc, pcloud, sublime-merge, bruno, claude-desktop"

    echo
    echo "  Development Tools:"
    echo "    abbr, basic-memory, claude-code, codex, github-copilot, mistral-vibe, opencode, ssh"

    echo
    echo "  System Components:"
    echo "    default-folders, doc, dotfiles, edit, open, os, postinstall, services, shims, submodules, symlinks, sync-files"

    ui_spacer
    ;;
  *)
    echo "Error: Unrecognized command '$1'. Use --help for a list of commands."
    exit 1
    ;;
  esac

fi
