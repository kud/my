#!/usr/bin/env zsh

# KeePassXC configuration file path
CONFIG_FILE="$HOME/Library/Application Support/keepassxc/keepassxc.ini"

# Ensure the KeePassXC configuration file exists
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "KeePassXC configuration file not found. Please launch KeePassXC at least once to generate it."
  exit 1
fi

# Function to update or add a key-value pair in a section
update_setting() {
  local section="$1"
  local key="$2"
  local value="$3"

  # Check if section exists, add it if not
  if ! grep -q "^\[$section\]" "$CONFIG_FILE"; then
    echo -e "\n[$section]" >> "$CONFIG_FILE"
  fi

  # Remove any existing key in the section
  sed -i '' "/^\[$section\]/,/^\[.*\]/ {/^$key=/d}" "$CONFIG_FILE"

  # Add the key=value pair to the section
  sed -i '' "/^\[$section\]/ a\\
$key=$value
" "$CONFIG_FILE"
}

# Update GUI settings
update_setting "GUI" "ApplicationTheme" "dark"
update_setting "GUI" "TrayIconAppearance" "monochrome"
update_setting "GUI" "CompactMode" "true"
update_setting "GUI" "MinimizeOnStartup" "true"

# Update Browser settings
update_setting "Browser" "Enabled" "true"
update_setting "Browser" "CustomProxyLocation" ""

# Update Password Generator settings
update_setting "PasswordGenerator" "AdditionalChars" "_-\xa3$%&*"
update_setting "PasswordGenerator" "AdvancedMode" "true"
update_setting "PasswordGenerator" "ExcludedChars" ""
update_setting "PasswordGenerator" "Length" "26"
update_setting "PasswordGenerator" "Logograms" "false"
update_setting "PasswordGenerator" "Math" "false"
update_setting "PasswordGenerator" "Type" "0"
update_setting "PasswordGenerator" "WordCount" "4"
update_setting "PasswordGenerator" "WordSeparator" "-"

# Update Security settings
update_setting "Security" "IconDownloadFallback" "true"

# Confirm success
echo "Configuration updated successfully. Restart KeePassXC to apply changes."
